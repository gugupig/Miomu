# æ–°æ•°æ®ç»“æ„å®ç°æ€»ç»“

## ğŸ¯ æ›´æ–°æ¦‚è¿°

æˆåŠŸå°†ä»£ç åº“æ›´æ–°ä»¥æ”¯æŒæ–°çš„æ•°æ®ç»“æ„ï¼Œä¸»è¦æ˜¯å°† `translation` å­—æ®µä»å­—ç¬¦ä¸²æ”¹ä¸ºå­—å…¸æ ¼å¼ï¼Œä»¥æ”¯æŒå¤šè¯­è¨€ç¿»è¯‘ã€‚

## ğŸ“‹ ä¸»è¦å˜æ›´

### 1. æ•°æ®æ¨¡å‹æ›´æ–° (models.py)

**æ–°çš„ Cue ç±»ç»“æ„:**
```python
@dataclass
class Cue:
    id: int
    character: Optional[str]  # æ”¯æŒ None (èˆå°æç¤º)
    line: str
    phonemes: Optional[str] = ""
    character_cue_index: int = -1
    translation: Dict[str, str] = field(default_factory=dict)  # ğŸ”¥ å­—å…¸æ ¼å¼
    notes: Optional[str] = ""
    style: str = "default"
    
    # æ–°å¢ä¾¿åˆ©æ–¹æ³•
    def get_translation(self, language_code: str) -> str
    def set_translation(self, language_code: str, text: str)
    def get_available_languages() -> List[str]
    def has_translation(self, language_code: str) -> bool
```

**æ–°å¢æ•°æ®ç±»:**
- `Meta`: å­—å¹•æ–‡ä»¶å…ƒæ•°æ®
- `Style`: æ ·å¼å®šä¹‰
- `SubtitleDocument`: å®Œæ•´æ–‡æ¡£ç»“æ„

### 2. JSON åŠ è½½æ›´æ–° (main_console.py)

**æ›´æ–°äº† LoadScriptThread ä¸­çš„ Cue åˆ›å»º:**
```python
script_data.cues.append(Cue(
    id=int(r["id"]),
    character=r.get("character"),        # æ”¯æŒ None
    line=r["line"],
    phonemes=phoneme_str,
    character_cue_index=r.get("character_cue_index", -1),
    translation=r.get("translation", {}),  # ğŸ”¥ å­—å…¸æ ¼å¼
    notes=r.get("notes", ""),
    style=r.get("style", "default")
))
```

### 3. ScriptTableModel æ›´æ–°

**å…¼å®¹æ€§ä¿®å¤:**
- å¤„ç† `character` å­—æ®µå¯èƒ½ä¸º `None` çš„æƒ…å†µ
- æ›´æ–°å¿«ç…§ä¿å­˜/æ¢å¤ä»¥æ”¯æŒæ‰€æœ‰æ–°å­—æ®µ
- ä¿®å¤æœç´¢åŠŸèƒ½ä¸­çš„ `None` å€¼å¤„ç†
- æ›´æ–°å¤åˆ¶åŠŸèƒ½å¤„ç† `None` è§’è‰²

**æ›´æ–°çš„å¿«ç…§æ–¹æ³•:**
```python
def save_snapshot(self):
    self._original_cues = [
        Cue(
            id=cue.id,
            character=cue.character,
            line=cue.line,
            phonemes=getattr(cue, 'phonemes', ''),
            character_cue_index=getattr(cue, 'character_cue_index', -1),
            translation=getattr(cue, 'translation', {}).copy(),  # æ·±æ‹·è´
            notes=getattr(cue, 'notes', ''),
            style=getattr(cue, 'style', 'default')
        ) for cue in self._cues
    ]
```

### 4. ScriptData ä¿å­˜æ›´æ–°

**æ”¯æŒæ‰€æœ‰æ–°å­—æ®µçš„ JSON ä¿å­˜:**
```python
def save_to_file(self, filepath: str | None = None) -> bool:
    cue_data = {
        "id": cue.id,
        "character": cue.character,
        "line": cue.line
    }
    
    # æ™ºèƒ½ä¿å­˜æ–°å­—æ®µï¼ˆä»…ä¿å­˜éé»˜è®¤å€¼ï¼‰
    if hasattr(cue, 'character_cue_index') and cue.character_cue_index != -1:
        cue_data["character_cue_index"] = cue.character_cue_index
    if hasattr(cue, 'translation') and cue.translation:
        cue_data["translation"] = cue.translation  # ğŸ”¥ å­—å…¸æ ¼å¼
    if hasattr(cue, 'notes') and cue.notes:
        cue_data["notes"] = cue.notes
    if hasattr(cue, 'style') and cue.style != "default":
        cue_data["style"] = cue.style
```

## ğŸš€ æ–°åŠŸèƒ½ç‰¹æ€§

### 1. å¤šè¯­è¨€ç¿»è¯‘å­—å…¸
```json
{
  "id": 1,
  "character": "å“ˆå§†é›·ç‰¹",
  "line": "ç”Ÿå­˜è¿˜æ˜¯æ¯ç­ï¼Œè¿™æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„é—®é¢˜ã€‚",
  "translation": {
    "en-us": "To be, or not to be, that is the question.",
    "fr-FR": "ÃŠtre ou ne pas Ãªtre, telle est la question.",
    "de-DE": "Sein oder nicht sein, das ist hier die Frage."
  }
}
```

### 2. ä¾¿åˆ©çš„ç¿»è¯‘ç®¡ç†æ–¹æ³•
```python
# è·å–ç¿»è¯‘
english = cue.get_translation("en-us")

# è®¾ç½®ç¿»è¯‘
cue.set_translation("ja-JP", "ç”Ÿãã‚‹ã¹ãã‹æ­»ã¬ã¹ãã‹")

# æŸ¥çœ‹å¯ç”¨è¯­è¨€
languages = cue.get_available_languages()  # ["en-us", "fr-FR", "de-DE", "ja-JP"]

# æ£€æŸ¥æ˜¯å¦æœ‰ç¿»è¯‘
has_english = cue.has_translation("en-us")  # True
```

### 3. å®Œæ•´çš„æ–‡æ¡£çº§ç®¡ç†
```python
# åˆ›å»ºå®Œæ•´æ–‡æ¡£
doc = SubtitleDocument(
    meta=Meta(title="å“ˆå§†é›·ç‰¹", language=["zh-CN", "en-US"]),
    styles={"default": Style(), "ä¸»è§’": Style(color="#FF0000")},
    cues=cues
)

# æ–‡æ¡£çº§æ“ä½œ
all_langs = doc.get_all_languages()  # è·å–æ‰€æœ‰ç¿»è¯‘è¯­è¨€
doc.add_language_to_all_cues("es-ES", "")  # ä¸ºæ‰€æœ‰å°è¯æ·»åŠ è¥¿ç­ç‰™è¯­åˆ—
```

## âœ… å…¼å®¹æ€§éªŒè¯

### æµ‹è¯•ç»“æœæ€»ç»“
- âœ… **æ–°æ•°æ®ç»“æ„åˆ›å»º**: æ‰€æœ‰æ–°å­—æ®µæ­£å¸¸å·¥ä½œ
- âœ… **ScriptTableModel å…¼å®¹**: ä¸ç°æœ‰UIå®Œå…¨å…¼å®¹
- âœ… **JSON ä¿å­˜/åŠ è½½å¾ªç¯**: æ•°æ®å®Œæ•´æ€§100%ä¿æŒ
- âœ… **ç¿»è¯‘æ–¹æ³•åŠŸèƒ½**: æ‰€æœ‰ä¾¿åˆ©æ–¹æ³•æ­£å¸¸å·¥ä½œ
- âœ… **æ–‡æ¡£ç»“æ„**: å…ƒæ•°æ®å’Œæ ·å¼ç³»ç»Ÿæ­£å¸¸
- âœ… **å‘åå…¼å®¹**: ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹

### æ•°æ®ä¸€è‡´æ€§éªŒè¯
ç»è¿‡å®Œæ•´çš„ä¿å­˜/åŠ è½½æµ‹è¯•ï¼Œç¡®è®¤ï¼š
- æ‰€æœ‰æ–°å­—æ®µæ­£ç¡®ä¿å­˜åˆ° JSON
- ä» JSON åŠ è½½åæ•°æ®100%ä¸€è‡´
- `character=None` çš„èˆå°æç¤ºæ­£ç¡®å¤„ç†
- å­—å…¸æ ¼å¼çš„ç¿»è¯‘å®Œæ•´ä¿æŒ

## ğŸ­ ä½¿ç”¨ç¤ºä¾‹

### æ”¯æŒçš„ JSON æ ¼å¼
```json
{
  "cues": [
    {
      "id": 1,
      "character": "å“ˆå§†é›·ç‰¹",
      "line": "ç”Ÿå­˜è¿˜æ˜¯æ¯ç­ï¼Œè¿™æ˜¯ä¸€ä¸ªå€¼å¾—è€ƒè™‘çš„é—®é¢˜ã€‚",
      "character_cue_index": 1,
      "translation": {
        "en-us": "To be, or not to be, that is the question.",
        "fr-FR": "ÃŠtre ou ne pas Ãªtre, telle est la question."
      },
      "notes": "è‘—åç‹¬ç™½",
      "style": "å“ˆå§†é›·ç‰¹"
    },
    {
      "id": 2,
      "character": null,
      "line": "(èˆå°æç¤º)",
      "character_cue_index": -1,
      "translation": {
        "en-us": "(Stage direction)",
        "fr-FR": "(Indication scÃ©nique)"
      },
      "notes": "èˆå°åŠ¨ä½œ",
      "style": "default"
    }
  ]
}
```

### ç¨‹åºä½¿ç”¨
```python
# 1. åœ¨ main_console.py ä¸­åŠ è½½JSONæ–‡ä»¶
# ç‚¹å‡»"åŠ è½½å‰§æœ¬"æŒ‰é’®ï¼Œé€‰æ‹©åŒ…å«æ–°æ ¼å¼çš„JSONæ–‡ä»¶

# 2. è‡ªåŠ¨æ”¯æŒå¤šè¯­è¨€ç¿»è¯‘
for cue in script_data.cues:
    if cue.translation:
        for lang, text in cue.translation.items():
            print(f"{lang}: {text}")

# 3. ç¼–è¾‘å’Œä¿å­˜
# åœ¨ç¼–è¾‘æ¨¡å¼ä¸­ä¿®æ”¹åï¼Œä¿å­˜æ—¶è‡ªåŠ¨åŒ…å«æ‰€æœ‰æ–°å­—æ®µ
```

## ğŸ”§ æŠ€æœ¯ä¼˜åŠ¿

1. **æ•°æ®å®Œæ•´æ€§**: æ·±æ‹·è´å­—å…¸ï¼Œé¿å…å¼•ç”¨é—®é¢˜
2. **æ€§èƒ½ä¼˜åŒ–**: åªä¿å­˜éé»˜è®¤å€¼ï¼Œå‡å°‘æ–‡ä»¶å¤§å°
3. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ç±»å‹æ³¨è§£å’ŒéªŒè¯
4. **æ‰©å±•æ€§**: æ–°å­—æ®µçš„æ·»åŠ ä¸å½±å“ç°æœ‰åŠŸèƒ½
5. **å›½é™…åŒ–æ”¯æŒ**: åŸç”Ÿå¤šè¯­è¨€å­—å…¸ç»“æ„

## ğŸ“ è¿ç§»æŒ‡å—

### å¯¹äºç°æœ‰JSONæ–‡ä»¶
- **è‡ªåŠ¨å…¼å®¹**: æ—§æ ¼å¼çš„JSONæ–‡ä»¶å¯ä»¥ç›´æ¥åŠ è½½
- **æ¸è¿›å‡çº§**: æ–°å­—æ®µä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸å½±å“åŠŸèƒ½
- **ä¿å­˜å‡çº§**: ä¿å­˜åè‡ªåŠ¨å‡çº§ä¸ºæ–°æ ¼å¼

### å¯¹äºå¼€å‘è€…
- **APIä¿æŒä¸å˜**: æ‰€æœ‰ç°æœ‰çš„æ–¹æ³•è°ƒç”¨ä¿æŒå…¼å®¹
- **æ–°åŠŸèƒ½å¯é€‰**: æ–°çš„ç¿»è¯‘æ–¹æ³•æ˜¯é¢å¤–åŠŸèƒ½
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„ `None` å€¼å’Œç¼ºå¤±å­—æ®µå¤„ç†

## ğŸ‰ æ€»ç»“

æ–°æ•°æ®ç»“æ„çš„å®ç°æ˜¯ä¸€ä¸ªé‡å¤§å‡çº§ï¼Œæä¾›äº†ï¼š

1. **æ›´å¼ºå¤§çš„å¤šè¯­è¨€æ”¯æŒ** - å­—å…¸æ ¼å¼çš„ç¿»è¯‘ç³»ç»Ÿ
2. **æ›´å®Œæ•´çš„å…ƒæ•°æ®ç®¡ç†** - ä½œå“ä¿¡æ¯ã€æ ·å¼å®šä¹‰
3. **æ›´çµæ´»çš„å†…å®¹ç±»å‹** - æ”¯æŒèˆå°æç¤ºå’Œå¤‡æ³¨
4. **å®Œå…¨å‘åå…¼å®¹** - ç°æœ‰åŠŸèƒ½æ— ç¼è¿‡æ¸¡
5. **ç”Ÿäº§å°±ç»ª** - å®Œæ•´æµ‹è¯•éªŒè¯ï¼Œæ•°æ®å®‰å…¨å¯é 

ç°åœ¨æ‚¨çš„ Miomu åº”ç”¨å·²ç»æ”¯æŒæœ€æ–°çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥å¤„ç†å¤æ‚çš„å¤šè¯­è¨€å­—å¹•é¡¹ç›®ï¼ğŸš€
