# 数据模型更新总结

## 更新概述

根据 `subtitle_sample.json` 的结构，成功更新了 `app/models/models.py` 中的数据类，以支持更丰富的字幕功能。

## 主要变更

### 1. Cue 类增强

**原有字段:**
```python
@dataclass
class Cue:
    id: int
    character: str
    line: str
    phonemes: Optional[str] = ""
```

**更新后字段:**
```python
@dataclass
class Cue:
    id: int
    character: Optional[str]  # 支持 None (舞台提示)
    line: str
    phonemes: Optional[str] = ""
    character_cue_index: int = -1  # 角色台词索引
    translation: Optional[str] = ""  # 翻译
    notes: Optional[str] = ""  # 备注
    style: str = "default"  # 样式名称
```

**新增字段说明:**
- `character`: 改为 `Optional[str]` 以支持舞台提示 (None)
- `character_cue_index`: 角色的台词序号，舞台提示为 -1
- `translation`: 翻译文本，支持多语言字幕
- `notes`: 备注信息，用于导演指示等
- `style`: 样式名称，对应样式定义

### 2. 新增数据类

**Meta 类 - 字幕文件元数据:**
```python
@dataclass
class Meta:
    title: str = ""              # 作品标题
    author: str = ""             # 原作者
    translator: str = ""         # 翻译者
    version: str = "1.0"         # 版本号
    description: str = ""        # 描述
    language: List[str] = field(default_factory=list)  # 语言列表
    created_at: Optional[str] = None    # 创建时间
    updated_at: Optional[str] = None    # 更新时间
    license: str = ""            # 许可证
```

**Style 类 - 样式定义:**
```python
@dataclass
class Style:
    font: str = "Noto Sans"      # 字体
    size: int = 42               # 字号
    color: str = "#FFFFFF"       # 颜色
    pos: str = "bottom"          # 位置
```

**SubtitleDocument 类 - 完整文档结构:**
```python
@dataclass
class SubtitleDocument:
    meta: Meta = field(default_factory=Meta)
    styles: Dict[str, Style] = field(default_factory=lambda: {"default": Style()})
    cues: List[Cue] = field(default_factory=list)
```

### 3. 兼容性修复

**ScriptTableModel 修复:**
- 处理 `character` 字段可能为 `None` 的情况
- 更新数据显示逻辑: `return cue.character or ""`
- 修复排序功能: `key=lambda cue: cue.character or ""`

**MainConsole 修复:**
- 更新状态显示: `f"当前台词: {cue.id} - {cue.character or '(舞台提示)'}"`

## JSON 文件支持

现在完全支持如下格式的 JSON 文件:

```json
{
  "meta": {
    "title": "哈姆雷特 (节选)",
    "author": "威廉·莎士比亚",
    "translator": "朱生豪",
    "language": ["zh-CN", "fr-FR"]
  },
  "styles": {
    "default": { "font": "Noto Sans", "size": 42, "color": "#FFFFFF" },
    "哈姆雷特": { "color": "#FF80B0" }
  },
  "cues": [
    {
      "id": 1,
      "character": "哈姆雷特",
      "character_cue_index": 1,
      "line": "生存还是毁灭，这是一个值得考虑的问题。",
      "translation": "To be, or not to be, that is the question.",
      "notes": "独白，舞台中央，灯光聚焦",
      "style": "哈姆雷特"
    },
    {
      "id": 3,
      "character": null,  // 舞台提示
      "character_cue_index": -1,
      "line": "(哈姆雷特转身，没有看她)",
      "translation": "(Hamlet turns away, without looking at her)",
      "notes": "这是一个舞台提示，不是台词",
      "style": "default"
    }
  ]
}
```

## 功能增强

### 1. 舞台提示支持
- `character` 为 `null` 时自动识别为舞台提示
- UI 中显示为 "(舞台提示)" 而不是空白
- `character_cue_index` 为 -1 表示非角色台词

### 2. 多语言翻译
- `translation` 字段存储默认翻译
- 结合多语言列功能支持无限语言
- 每个 cue 可以有主要语言 + 多个翻译

### 3. 丰富的元数据
- 完整的作品信息管理
- 版本控制和许可证追踪
- 多语言标签支持

### 4. 样式系统
- 角色特定的样式定义
- 支持字体、颜色、大小、位置
- 舞台提示使用默认样式

## 向后兼容性

✅ **完全向后兼容** - 所有原有代码继续正常工作
- 原有的 `Cue(id, character, line)` 构造仍然有效
- 新字段都有默认值，不影响现有功能
- ScriptTableModel 和 UI 组件无缝适配

## 测试验证

通过了全面的兼容性测试:
- ✅ 传统 Cue 对象创建和使用
- ✅ 完整字段的 Cue 对象
- ✅ 舞台提示 (character=None) 处理
- ✅ ScriptTableModel 数据显示和排序
- ✅ JSON 文件加载和解析
- ✅ 多语言功能与新字段结合
- ✅ UI 显示正确性

## 使用示例

### 创建传统 Cue (兼容性)
```python
cue = Cue(id=1, character="角色A", line="台词内容")
```

### 创建完整 Cue (新功能)
```python
cue = Cue(
    id=1,
    character="哈姆雷特",
    line="生存还是毁灭，这是一个值得考虑的问题。",
    character_cue_index=1,
    translation="To be, or not to be, that is the question.",
    notes="独白，舞台中央，灯光聚焦",
    style="哈姆雷特"
)
```

### 创建舞台提示
```python
stage_cue = Cue(
    id=2,
    character=None,  # 舞台提示
    line="(灯光暗下)",
    character_cue_index=-1,
    translation="(Lights fade)",
    notes="舞台指示",
    style="default"
)
```

### 从 JSON 加载
```python
from app.models.models import Cue

# JSON 数据自动映射到 Cue 对象
cue = Cue(
    id=cue_data['id'],
    character=cue_data.get('character'),  # 处理 null
    line=cue_data['line'],
    character_cue_index=cue_data.get('character_cue_index', -1),
    translation=cue_data.get('translation', ''),
    notes=cue_data.get('notes', ''),
    style=cue_data.get('style', 'default')
)
```

## 总结

这次数据模型更新是一个重大的功能增强，同时保持了完全的向后兼容性。现在的系统支持:

1. **更丰富的字幕信息** - 翻译、备注、样式等
2. **舞台提示处理** - 专门的非角色内容支持  
3. **完整的元数据管理** - 作品信息、版本控制
4. **灵活的样式系统** - 角色特定的显示样式
5. **JSON 标准化** - 与行业标准格式兼容

新的数据模型为后续的功能扩展奠定了坚实的基础！
